# Next.js

React 기능을 강화하는 생산용 프레임워크

NextJS는 React 앱에 많은 기능을 간단히 추가 / 바로 사용할 수 있도록 한다

<br><br>

## NextJS - Key Features & Benefits

- SSR 서버 사이드 렌더링을 내장

  - 추가 설정 없이도, 페이지에 방문했을 때 서버에서 기본적으로 사전 렌더링 진행

  - 사용자에게 더 나은 초기 로딩 환경을 제공

  - ReactJS에도 해당 기능이 내장되어있지만, 추가설정이 필요하여 제대로 구현하기 까다로울 수 있음

- File-based Routing 파일 기반 라우팅

  - React-Router
    페이지 역할을 하는 컴포넌트를 만들고, 라우터 코드를 따로 작성한다
  - NextJS는 이러한 코드 내 라우트 정의를 없앤다
  - **파일, 폴더를 이용해서 페이지와 라우트를 정의**한다
    - NextJS 앱에는 특수 페이지 폴더가 존재 (pages)
    - 페이지가 지원하는 라우트와 경로를 정의
  - less code, less work, highly understandable concept

- Fullstack Capabilities
  - 백엔드 API를 쉽게 추가할 수 있음
  - 데이터베이스나 파일에 데이터 저장하거나 받아오거나, 인증을 추가하는 등 모든 작업을 할 수 있음

### About `_app.js`

- **`_app.js`** 파일은 Next.js 애플리케이션에서 전역적으로 적용되는 컴포넌트
- 모든 페이지에서 사용되는 공통 레이아웃이나 상태 관리 로직 등을 구현할 때 사용됨
- **`_app.js`** 파일은 다음과 같은 몇 가지 기능을 제공함
  1. 페이지 전환 시에 상태값 유지하기: **`_app.js`** 파일 안에서 **`getInitialProps()`** 메서드를 사용하면 페이지 전환 시에 상태값을 유지할 수 있습니다.
  2. 페이지 전환 시에 전역적으로 적용되는 애니메이션 효과 적용하기: **`_app.js`** 파일 안에서 페이지 전환 시에 전역적으로 적용되는 애니메이션 효과를 적용할 수 있습니다.
  3. 전역적으로 적용되는 CSS 설정하기: **`_app.js`** 파일 안에서 전역적으로 적용되는 CSS 스타일을 설정할 수 있습니다. 이를 통해 CSS-in-JS 라이브러리를 사용하여 스타일을 적용할 수 있습니다.
  4. 서버에서 사용되는 컴포넌트 설정하기: **`_app.js`** 파일 안에서 서버에서 사용되는 컴포넌트를 설정할 수 있습니다. 이를 통해 서버 측에서도 컴포넌트를 렌더링할 수 있습니다.

## Pre-rendering

- NextJS는 기본적으로 모든 페이지를 사전 렌더링함
- 클라이언트 사이드 JavaScript에서 모든 작업을 수행하는 대신 미리 각 페이지에 대한 HTML을 생성함
- 사전 렌더링을 통해 더 나은 성능과 SEO를 얻을 수 있음
- 생성된 HTML은 해당 페이지에 필요한 최소한의 JS코드와 연결됨

### 사전 렌더링이 진행중인지 확인하려면 ?

1. 브라우저에서 JavaScript를 비활성화 하기

   → [크롬에서 비활성화 하는 방법](https://developer.chrome.com/docs/devtools/javascript/disable/)

2. 페이지에 access해보기

결과

- Next.js가 앱을 정적 HTML로 사전 렌더링을 했기 때문에 JavaScript를 실행하지 않고도 앱 UI가 렌더링 되는 것을 확인 할 수 있음

## Two Forms of Pre-rendering

Next.js에는 두가지 렌더링 형식이 있다.

1. 정적생성(Static Generation)
2. 서버 측 렌더링(Server-side Rendering)

페이지에 대한 HTML을 생성할 때 차이점이 존재한다.

### Static Generation 정적생성

- 빌드 시 HTML을 생성하는 사전 렌더링 방법
- 미리 렌더링된 HTML이 각 요청에서 재사용됨

### Server-side Rendering 서버 측 렌더링

- 각 요청에서 HTML을 생성하는 사전 렌더링 방법

<aside>
💡 Next.js 는 각 페이지에 사용할 사전 렌더링 양식을 선택할 수 있다.
대부분의 페이지는 정적 생성을 사용하고 다른 페이지에는 서버 사이드 렌더링을 사용하여 **하이브리드 Next.js 앱**을 만들 수 있다.

</aside>

### When to Use **[Static Generation](https://nextjs.org/docs/basic-features/pages#static-generation-recommended) vs [Server-side Rendering](https://nextjs.org/docs/basic-features/pages#server-side-rendering)**

가능한 한 정적생성을 사용하는 것이 좋다.

요청이 있을 때마다 서버에서 페이지를 렌더링 하는 것보다 훨씬 빠르기 때문

### 정적생성을 선택하는 기준?

- 질문하기 : 사용자 요청에 앞서, 이 페이지를 미리 렌더링 할 수 있는가?
- 정적생성을 사용하는 유형의 페이지
  - Marketing pages
  - Blog posts
  - E-commerce product listings
  - Help and documentation

### 서버 사이드 렌더링을 선택하는 기준?

- 정적생성의 질문에 대한 대답이 NO 이거나
- 페이지에 자주 업데이트되는 데이터가 표시되는 경우
  → 속도는 느려지지만 미리 렌더링된 페이지는 항상 최신 상태이다.
  → 사전 렌더링을 건너뛰고 클라이언트측JS를 사용하여 자주 업데이트되는 데이터를 채울 수 있다

## **Static Generation with Data using `getStaticProps`**

- getStaticProps는 프로덕션 빌드 시 생성됨
- 함수 내에서 외부 데이터를 가져와 페이지에 대한 props로 보낼 수 있음
- 개발모드에서는 getStaticProps가 각 요청에서 실행됨

```js
export default function Home(props) { ... }

export async function getStaticProps() {
  // Get external data from the file system, API, DB, etc.
  const data = ...

  // The value of the `props` key will be
  //  passed to the `Home` component
  return {
    props: ...
  }
}
```

## CSR

> 렌더링을 하는 주체가 클라이언트 (브라우저)

- 리액트 웹앱의 경우 유저가 홈페이지에 접속하면
- 클라이언트가 서버에게 웹페이지에대한 정보에 대해 요청을 보내고, 서버는 body가 `빈 HTML 파일`을 먼저 보내준다.
- 빈 페이지가 유저에게 보여진다.
- 이후 `리액트 라이브러리 소스파일`, `리액트 컴포넌트로 만든 소스코드`를 서버로부터 다운받는다.
- 이렇게 3가지 파일이 모두 다운로드 되어야 클라이언트 측에서 렌더링할 준비가 완료된다.

📍 정리
HTML 파일 + 리액트 라이브러리 + 리액트 컴포넌트로 만든 소스코드를 서버로부터 다운받아서, 클라이언트 측에서 DOM요소로 변환하여 브라우저에 표기하는 것

📍 장점
한번 로딩이 되면, 빠른 UX를 제공할 수 있다. (SPA이므로)
또한 필요한 곳에서만 부분적으로 데이터를 가져와서 업데이트하기 때문에, 서버 부하가 적다.

📍 단점

- TTV가 길다.
- 자바스크립트 활성화가 필수적이다.
  (HTML파일에는 어떠한 요소도 없기 때문..!)
- SEO 최적화가 힘들다.
- 보안에 취약하다
  (CSR 특성상 클라이언트에서 모든 코드를 다운받게되는데, 이 코드에는 중요한 정보들도 담겨있을 것이기 때문에)
- CDN에 HTML 페이지 캐시가 안된다.

CDN에 대해서는 아래에서 다시 정리해볼 것이다.

👉 CSR의 이러한 단점을 해결하기 위해 Next.js 프레임워크가 등장하였고
다른 방식을 사용하여 이를 보완할 수 있다.

## SSG

> 렌더링하는 주체가 서버이며, 빌드할 때 렌더링을 진행한다.

- 유저가 홈페이지에 접속하면 클라이언트는 서버에게 홈페이지를 요청한다.
- 서버에서는 `빌드시점에 미리 만들어진 html 파일`을 보내준다.
- 이 파일을 클라이언트 측에서 표기해준다.
  ❊ CDN에 캐시된 html파일을 빠르게 가져올 수 있음

📍 장점

- TTV가 빠름
- 자바스크립트 활성화 필요 없음
- SEO 최적화가 좋음
  (웹 크롤러가 빠르고 효율적으로 페이지를 확인)
- 보안이 좋음
  (불필요하게 모든 코드를 클라이언트 측에 보내지 않아도 되기 때문에)
- CDN에 캐시가 됨 🙌

📍 단점

- 빌드 시점에 렌더링이 진행되므로
  - 데이터가 정적임
  - 사용자별 정보 제공이 어려움

## ISR (Incremental Staticc Regeneration)

> 렌더링하는 주체가 서버이며, 주기적으로 렌더링을 진행함

SSG + 설정한 시간 간격만큼 주기적으로 하는 방식이기 때문에
렌더링 과정이나, SSG의 장점을 그대로 가져간다.

주기적으로 렌더링을 진행하면서
추가되는 장점과 단점은 아래와 같다.

📍 장점

- 데이터가 주기적으로 업데이트됨

📍 단점

- 여전히 실시간 데이터가 아님
- 따라서 사용자별 정보 제공의 어려움

## SSR (Server Side Rendering)

> 렌더링하는 주체가 서버이며, 요청시 렌더링을 진행함

- 서버에 배포해둔 Next.js 어플이 존재
- 클라이언트가 서버에 홈페이지를 요청
- 서버에서 홈페이지에 필요한 코드를 실행하고, 데이터를 읽어오는 등 서버에 필요한 모든 것을 처리 후 html파일을 만들고, 이 파일을 클라이언트로 보내준다.
- 클라이언트에서 요청이 올때마다 페이지를 새롭게 만들어서 준다.

📍 장점

- TTV가 빠름
- 자바스크립트 활성화 불필요
- SEO 최적화가 좋음
- 보안이 뛰어남
- 실시간 데이터를 사용함
- 사용자별 필요한 데이터를 제공함

다른 렌더링 방식의 단점들을 커버한 듯 보인다!

📍 단점

- SSG, ISR과 비교하였을 때 상대적, 비교적으로 느릴 수 있다
- 서버에 과부하가 걸릴 수 있다 (overhead)
  -> 모든 페이지를 SSR로 해버리면 🥵
- CDN에 캐시가 안됨

---

정리

이렇게 총 네가지의 렌더링 방식을 살펴보았다.
장점, 단점을 비교하며 알 수 있듯이
하나의 완벽한 렌더링 솔루션은 없으며
앱의 요구사항과 특징들에 따라 렌더링 방식을 결정해야할 것 같다.

Next.js에서는 페이지별 렌더링을 선택 or 혼합 할 수 있다. (Hybrid)

👉 데이터가 얼마나 자주 바뀌는지, 어떤 데이터인지에 따라
성능을 높이기 위해 특징에 따라 렌더링 방식을 선택하는 것이 좋겠다.

---

## Hydration ✨

> Next.js에서 Hybrid를 가능하게 하는 중요한 컨셉이다.

- 클라이언트가 서버에 홈페이지를 요청
- Next.js는 사용자가 빠르게 볼 수 있는, 의미있는 html을 먼저 보내준다.
  - 해당 페이지는 정적인 페이지로,
    서버에서 사용자에게 의미 있는 데이터를 먼저 보내주기 위해
    꼭 필요한 UI를 구성해서 만든 정적인 html 페이지이다.
  - pre-rendering 이라고도 부른다.
- 클라이언트에서 이 정적인 html 페이지를 빠르게 표기한다.
- 해당 페이지에는 자바스크립트 코드가 없기 때문에 사용자가 클릭해도 반응이 없다.
- 페이지에 필요한 리액트 라이브러리와 소스코드들을 서버로부터 다운받는다.
- 클라이언트에 다운로드가 완료되면, 정적인 페이지를 리액트 코드로 가득채운다.
  👉 리액트 하이드레이션 (컴포넌트 렌더링이 발생)
- 사용자가 클릭하면 컴포넌트 내 로직이 실행됨

📌 pre-rendering되는 정적인 html 페이지와, 하이드레이션 된 후의 간극을 줄여나가는 것이 Next.js 개발의 key point 이다.
