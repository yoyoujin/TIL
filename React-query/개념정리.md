# TanStack query

### TanStack Query의 핵심개념

- Queries
- Mutations
- Query Invalidation

## Queries

쿼리는 서버에서 데이터를 가져오기 위해 프로미스 기반의 메서드(GET,POST 등)와 함께 서버에서 데이터를 가져올 수 있음 (서버의 데이터를 수정하는 경우에는 Mutation을 사용하는 것이 좋음)

useQuery(a, b)

- a: 유니크한 키 값
- b: 프로미스를 반환하는 함수 (Resolves the data, Throws an error)

```
import { useQuery } from '@tanstack/react-query'

function App() {
  const info = useQuery({ queryKey: ['todos'], queryFn: fetchTodoList })
}
```

- 첫번째 인자의 고유 키는 쿼리를 다시 가져오고, 캐싱하고, 공유하기 위해 사용된다. (refetching, caching, and sharing)

- useQuery가 반환하는 결과값은 템플릿 및 데이터 사용에 필요한 쿼리에 대한 모든 정보를 담고 있다.

```
const result = useQuery({ queryKey: ['todos'], queryFn: fetchTodoList })
```

- `result` 객체에는 생산성을 위해 알아야 할 매우 중요한 상태가 포함되어있다.

- 쿼리의 기본상태

  - `isLoading` or `status === 'loading'`
    - 쿼리에 아직 데이터가 없음
  - `isError` or `status === 'error'`
    - 쿼리에 에러가 발생
  - `isSuccess` or `status === 'success'`
    - 쿼리가 성공 & 데이터를 사용할 수 있음

- 기본 상태 외에도 쿼리 상태에 따라 더 많은 정보를 사용할 수 있음
  - `error`
    - 쿼리의 상태가 `isError`인 경우, 에러는 `error` 프로퍼티를 통해 접근 가능하다
  - `data`
    - 쿼리의 상태가 `success`인 경우, 데이터는 `data` 프로퍼티를 통해 접근 가능하다

쿼리 상태의 활용

```
function Todos() {
  const { isLoading, isError, data, error } = useQuery({
    queryKey: ['todos'],
    queryFn: fetchTodoList,
  })

  if (isLoading) {
    return <span>Loading...</span>
  }

  if (isError) {
    return <span>Error: {error.message}</span>
  }

  // We can assume by this point that `isSuccess === true`
  return (
    <ul>
      {data.map((todo) => (
        <li key={todo.id}>{todo.title}</li>
      ))}
    </ul>
  )
}
```

### Fetch Status

- `fetchStatus === 'fetching'`
  - 쿼리가 fetching인 상태
- `fetchStatus === 'paused'`
  - 쿼리를 가져오려 했으나 일시중지됨 (fetch를 하려고했으나 멈춤)
- `fetchStatus === 'idle'`
  - 쿼리가 아무작업도 수행하지 않음

### `status`와 `fetchStatus`의 차이점 ?

status가 success인 상태면 fetchStatus는 보통 idle 상태가 된다. 그러나 background refetch가 일어나고 있다면 fetching 상태가 될 수도 있다.

혹은 쿼리가 마운트 되고 있거나, 데이터가 없으면 보통 loading이나 fetching 상태가 되지만, 네트워크 연결이 되지 않아서 paused 상태가 되기도 한다.

따라서 실제로 데이터를 가져오지 않고도 쿼리가 로드 상태있을 수 있다.

- `status`는 데이터에 대한 정보를 제공한다
- `fetchStatus`는 queryFn에 대한 정보를 제공한다
